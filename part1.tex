\chapter{Исследование и построение решения} \label{chapt1}

\section{Математическая модель поиска повторов в биологических последовательностях}

Формально {\bf биологическая последовательность}:
$$
X = (x_n)_{n=1}^N ,~ N \in \mathbb{N},~ x_n \in \{A,T,G,C\},
$$
где $N = |X|$ - длина последовательности, $A, T, G, C$ - обозначения нуклеотидов.

\bigskip

Введем обозначение. {\bf Подпоследовательностью $X|_i^k$} последовательности $X$
называется часть последовательности $X$ с элемента с номером $i$ длиной $k$
при условии $i+k<|X|$:
$$
X|_i^k=\{x_i,x_{i+1},...,x_{i+k-1}\}
$$

\bigskip

Под {\bf повтором} будем понимать пару последовательностей (X$_1$,X$_2$) для которых
справедливо неравенство:
$$
\rho(X_1,X_2) \le \varepsilon,~|X_2|=|X_2|=K
$$
где:
\begin{itemize}
    \item $\rho(X_1,X_2)$ - расстояние редактирования, оценка близости последовательностей,
        Конкретный вид функции расстояния редактирования $\rho(X_1,X_2)$~ {\bf определяется алгоритмом}
    \item $\varepsilon$ - задаваемая точность поиска, значение которой будет {\bf зависеть от задаваемой функции расстояния редактирования}
    \item $K$ - длина последовательностей
\end{itemize}

\bigskip

Пусть есть две последовательности $X=(x_n)_{n=1}^{N_x}$ и $Y=(y_n)_{n=1}^{N_y}$.\\
Под {\bf задачей поиска повторов} будем понимать нахождение всех троек $\{i_x,i_y,k\},
\ i_x,i_y,k \in \mathbb{N}$, таких что:\\
\begin{center}
    $i_x+k \le N_x$\\
    $i_y+k \le N_y$\\
    $(X|_{i_x}^k,Y|_{i_y}^k) - \text{повтор длины} k$
\end{center}
То есть задача найти все такие подпоследовательности последовательностей $X$ и $Y$,
что эти подпоследовательности будут повторами.

\clearpage







\section{Спектрально-аналитический метод поиска повторов}
В работе исследуется спектральный метод поиска повторов в биологических последовательностях
предложенный и разработанный коллективом кафедры математических методов
прогнозирования ВМК МГУ и института математических проблем в биологии Российской академии
наук (Пущино).

\bigskip
Метод разбивается на четыре основных этапа:
\begin{enumerate}
  \item Получение профилей биологических последовательностей
  \item Спектральное индексирование полученных профилей
  \item Сравнение коэффициентов спектрального индексирования и построение гомологической матрицы
  \item Анализ гомологической матрицы
\end{enumerate}

\bigskip

\subsection{Профили биологических последовательностей} \label{sect2_1}

Одной из главных особенностей рассматриваемого метода поиска повторов является
то, что на первом этапе последовательность преобразуется из дискретной в непрерывную
область. Это достигается построением т.н. профилей.

\bigskip

Под GC-профилем последовательности $X = (x_n)_{n=1}^{N_x}$ с окном $w$ в дальнейшем
будем понимать такую последовательность $P_{GC}(X,w)=(p_n^{GC})_{n=1}^{N_p},
N_p=N_x-w+1$, что
$$
p_i^{GC}=\sum_{k=i}^{i+w}I^{GC}(x_k), i=\overline{1,N_p}
$$

где
$$
I^{GC}=
  \begin{cases}
    1,~x_n \in \{G,C\} \\
    0,\text{~иначе}
  \end{cases}
, n = \overline{1,N_x}
$$

\bigskip
\bigskip

Понятие GA-профиля определяется аналогично:
$$
P_{GA}(X,w)=(p_n^{GA})_{n=1}^{N_p}:
p_i^{GA}=\sum_{k=i}^{i+w}I^{GA}(x_k), i=\overline{1,N_p},
$$
где
$$
I^{GA}=
  \begin{cases}
    1,~x_n \in \{G,C\} \\
    0,\text{~иначе}
  \end{cases}
, n = \overline{1,N_x}
$$
\clearpage



\subsection{Спектральное индексирование профилей} \label{sect2_2}

На этом этапе профили переводятся в спектральное представление с использованием
в качестве базиса полиномов Чебышева дискретного аргумента.

\bigskip

Под спектральным представлением сигнала $P=(p_n)_{n=1}^{N_p}$ будем понимать вектор
$\overline{C}=C_m(P)=(c_0,...,c_{m-1})$, где $c_0,...,c_{m-1}$ - первые $m$
коэффициентов разложения сигнала P по некоторой системе ортогональных функций
$u_0(x),...,u_{m-1}(x),...$


\bigskip

Полиномы Чебышева определяются при помощи рекуррентного соотношения:\\
$$ u_0(x)=1 $$
$$ u_1(x)=x $$
$$ ... $$
$$ u_{n+1}(x)=2xu_n(x)-u_{n-1}(x) $$

\bigskip

Вычисление коэффициентов разложения выполняется по рекуррентным соотношениям.

\bigskip

\subsection{Спектральное сравнение профилей} \label{sect2_3}

На этой стадии спектральное представление профилей используется для
производства сравнения на основе некоторого специально разработанного критерия.

Теперь можно ввести понятие расстояния редактирования для рассматриваемого
метода поиска повторов.

Пусть $X_1,X_2$ - две биологические последовательности, такие что $|X_1|=|X_2|=K \ge w$.\\
Будем понимать под GC- и GA-расстоянием редактирования для $X_1$ и $X_2$:
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
$$ \rho^{GC}(X_1,X_2)= \norm{\overline{C_1^{GC}} - \overline{C_2^{GC}}}, $$
$$ \rho^{GA}(X_1,X_2)= \norm{\overline{C_1^{GA}} - \overline{C_2^{GA}}}, $$
$$ \norm{\overline{C}}=\sum_{i=0}^{m-1}c_i^2 $$

\bigskip

Под повтором будем понимать пару последовательностей $X_1,X_2$,
удовлетворяющих системе:

\bigskip

$$
  \begin{cases}
      \rho^{GC}(X_1,X_2) < \varepsilon \\
      \rho^{GA}(X_1,X_2) < \varepsilon \\
  \end{cases}
$$

\clearpage


Под матрицей гомологии с окном профилирования  $w$, окном аппроксимации a и шагом
аппроксимации s для последовательностей $X_1,X_2$ будем понимать матрицу
$$
\begin{array}{rl}
    M(X,Y,w,s,a)=(m_{ij})^{L_x \times L_y}, \\
      \\
    L_x=[\frac{N_x-a-w+1}{s}],L_y=[\frac{N_y-a-w+1}{s}] \\
      \\
    m_{ij}=
      \begin{cases}
        1,~x_n \in \{G,C\} \\
        0,~$иначе$ \\
      \end{cases}
\end{array}
$$

\bigskip
\bigskip

\begin{figure}[h]
\center{\includegraphics[width=0.5\linewidth]{image/cool.jpg}}
\caption{Пример гомологической матрицы}
\label{img:gomology}
\end{figure}

На рисунке \ref{img:gomology} приведена гомологическая матрица, образованная
в результате сравнения искусственной последовательности с самой собой. Матрица имеет
симметричный вид.

\bigskip

\bigskip

\subsection{Анализ гомологической матрицы} \label{sect2_4}

Рассмотрим все диагонали гомологической матрицы параллельные главной диагонали,
включая ее саму. Фиксируем диагональ $D_l$.
Назовем диагональным элементом $R(x, y, k)$ такое множество элементов $m_{ij}$
гомологической матрицы $M^{L_x \times L_y}$, что:
$$ m_{ij} \in D_l$$
$$ m_{ij} = 1,\quad i = \overline{y,y\!+\!k-1}, \quad j = \overline{x,x+k-1}, k \in \mathbb{N}$$
$$ m_{x-1,y-1} = 0, \text{если}~x > 0, y > 0$$
$$ m_{x+k,y+k} = 0, \text{если}~x+k < L_x , y+k < L_y$$

На последнем этапе анализа гомологической матрицы нужно найти все
диагональные элементы этой матрицы. Зная параметры алгоритма по диагональным
элементам можно восстановить искомые повторы.

\clearpage


\begin{figure}[H]
\center{\includegraphics[width=0.5\linewidth]{image/shemeAlgorithm.png}}
\caption{Схема работы спектрально-аналитического метода поиска повторов}
\label{img:shemeAlgorithm}
\end{figure}

%На рисунке \ref{img:shemeAlgorithm} представлена общая схема работы спектрально-аналитического метода.

\clearpage

\section{Параллельный метод поиска повторов}

Основная идея параллельного алгоритма поиска повторов заключается
в равномерном распределении входных данных по процессам и их независимой обработке,
запрашивая недостающие элементы у соседних процессов.

При разработке параллельного алгоритма во главу угла была поставлена автономность
каждого этапа вычислений. Такой подход позволяет
достигнуть следующих результатов:
\begin{itemize}
    \item Логическое следование алгоритму
    \item Прозрачность системы
    \item Возможность отладки каждого этапа
\end{itemize}

\subsection{Профилирование и спектральное индексирование}

На рисунке \ref{img:phase12} представлена схема выполнения первых двух этапов: получения профиля
биологической последовательности и спектрального индексирования.

\begin{figure}[h]
\center{\includegraphics[width=1.0\linewidth]{image/phase12.png}}
\caption{Параллельная схема работы этапа профилирования и спектрального индексирования}
\label{img:phase12}
\end{figure}

Параллельная схема двух этапов очень похожа, поэтому есть смысл
рассматривать их вместе.
Входная последовательность равномерно разбивается между всеми процессами и на каждом этапе процесс получает недостающие элементы у соседнего процесса справа и выполняет
обработку данных. Данная схема основывается на принципе независимого выполнения
этапов.

Естественно, что такой алгоритм не единственно возможный.
Например, можно было бы использовать такую схему, когда профилирование
и спектральное индексирование объединялись бы в один этап и по параметрам
алгоритма каждый процесс рассчитывал сколько ему нужно взять элементов таким
образом, чтобы обойтись без пересылок между процессами.
Но такой подход имеет и ряд недостатков: дублирование вычислений, сложность отладки, невозможность повторного использования данных для других параметров алгоритма.

К недостаткам предложенного алгоритма можно отнести обмены между процессами.
Однако каждый процесс может начинать работу не дожидаясь завершения
приема данных, т.к. они понадобятся только в конце работы. Таким образом можно
скрыть передачу данных на фоне выполнения полезной работы и добиться ситуации,
когда процессор не будет простаивать в ожидании данных.

Ниже рассматриваются два способа организации этапа спектрального сравнения
и анализа гомологической матрицы.


\subsection{Спектральное сравнение и анализ матрицы гомологии. Матричный метод}

Во время спектрального сравнения каждый процесс будет отвечать за сравнение
своей части спектров первой последовательности со всеми спектрами
второй последовательности. Таким образом процесс будет хранить часть строк
гомологической матрицы, соответствующих спектрам из первого набора.

\begin{figure}[h]
\center{\includegraphics[width=0.7\linewidth]{image/matrix.png}}
\caption{Сравнение спектров. Матричный метод}
\label{img:matrix}
\end{figure}

Для выполнения данного этапа процессу требуются собрать спектры
второй последовательности со всех процессов.
Однако и здесь можно добиться отсутствия простоя вычислительных платформ,
если не дожидаться получения всех данных,
а начинать работу по возможности. То есть как только придут данные хотя бы
с одного процесса - сразу строить часть матрицы.
Таким образом можно скрыть большую часть пересылок данных за полезными вычислениями
и добиться хорошей масштабируемости алгоритма.

На последнем этапе каждый процесс анализирует имеющуюся часть гомологической
матрицы на наличие диагональных элементов. Однако следует учитывать, что найденный
диагональный элемент может иметь свое начало или окончание на другом процессе и
таким образом быть разбитым по процессам,
поэтому нужно ``склеить'' диагональные элементы с разных процессов.

Здесь будем действовать по следующему принципу: процесс ``склеивает'' диагональный элемент
(т.е. ищет его целиком), только если диагональный элемент принадлежит нашему процессу.
Диагональный элемент $R(x, y, k)$ принадлежит процессу $i$, если начало этого повтора находится на процессе $i$, т.е.:
$$ R(x, y, k) \in i, \text{если } m_{xy} \in M_i^{L_x \times L_y},$$
$$\text{где}~M_i^{L_x \times L_y} - \text{гомологическая матрица, вычисленная на процессе}~i$$

Таким образом алгоритм анализа гомологической матрицы будет работать следующим образом:
\begin{enumerate}
    \item Найти все диагональные элементы
    \item Удалить диагональные элементы, не принадлежащие нашему процессу
    \item Найти конец всех диагональных элементов
\end{enumerate}

Такой алгоритм нахождения диагональных элементов, при котором последовательно
идут этапы спектрального сравнения с полным построением матрицы гомологии
и ее последующим анализом будем называть матричным методом.

\subsection{Спектральное сравнение и анализ матрицы гомологии. Блочный метод}

Явным недостатком матричного метода является объем памяти, необходимый
для гомологической матрицы. Размер этой матрицы $\sim N / s$, где $N$ - длина входной
последовательности, $s$ - сдвиг окна индексирования. Тогда, например, объем гомологической
матрицы, необходимый для анализа человеческого генома (3.1 млрд. н.п.)
со сдвигом $s$ равным 100, будет составлять ($3.1 * 10^7 * 3.1 * 10^7 \sim 9 * 10^{14}$) 900 ТБ.
Такой размер гомологической матрицы существенно сокращает количество возможных
вычислительных платформ на которых можно было бы запускать программу.

Чтобы уйти от этого недостатка нам придется пренебречь принципом автономности
этапов. Основная идея блочного метода заключается в чередовании этапов
спектрального индексирования и анализа гомологической матрицы для обработки
небольшого блока.

Итак, пусть пользователь задает новый параметр алгоритма - лимит оперативной
памяти для гомологической матрицы. Также как и в матричном методе процесс
будет отвечать за сравнение спектров первой последовательности со всеми спектрами
второй последовательности. Единственное отличие блочного метода от матричного в том,
что результат сравнения не будет сохраняться
в матрице гомологии, а будет сразу же подвергаться анализу на наличие диагональных
элементов. Таким образом гомологическая матрица становится чисто виртуальной
структурой - на деле ничего в памяти не хранится.
\clearpage

\begin{figure}[h]
\center{\includegraphics[width=0.7\linewidth]{image/block.png}}
\caption{Сравнение спектров. Блочный метод}
\label{img:block}
\end{figure}


На рис. \ref{img:block} разобрана схема блочного метода. Как только процесс принял часть спектров
второй последовательности начинается их сравнение со спектрами первой последовательности.
Выделяется блок памяти, объем которого не превышает заранее определенной
квоты пользователя.
Строится часть виртуальной гомологической матрицы равная размеру выделенного блока.
Блок сразу же подвергается анализу и результат анализа сохраняется в списке диагональных элементов.
\clearpage

\begin{figure}[h]
\center{\includegraphics[width=0.7\linewidth]{image/mergeVertical.png}}
\caption{Склейка по вертикали}
\label{img:mergeV}
\end{figure}

Блок сдвигается ниже на его высоту, идет построение и анализ.
Результат анализа ``склеивается'' по вертикали с предыдущими результатами (рис. \ref{img:mergeV}).
Операция ``склейки'' диагональных элементов по вертикали не имеет ничего общего
со ``склейкой'' между процессами, т.к. здесь процесс знает всю информацию
о склеивающихся структурах.

\begin{figure}[h]
\center{\includegraphics[width=0.7\linewidth]{image/mergeHorizontal.png}}
\caption{Склейка по горизонтали}
\label{img:mergeH}
\end{figure}

После построения столбца виртуальной гомологической матрицы результат
сохраняется и происходит построение следующего столбца. После его постройки
происходит ``склейка'' диагональных элементов по горизонтали. И так далее,
пока не получим результат анализа с одним из процессов (см. рис \ref{img:mergeH}).

\begin{figure}[h]
\center{\includegraphics[width=0.3\linewidth]{image/mergeProcess.png}}
\caption{Склейка по горизонтали процессов}
\label{img:mergeP}
\end{figure}

На последнем этапе будем иметь результаты анализа сравнения со всеми процессами.
Остается применить ко всем операцию ``склейка'' горизонтали, и получим список
диагональных элементов (см. рис \ref{img:mergeP}).

То есть будем иметь такой же список, как и при матричном способе. Остается
применить операцию ``склейка'' процессам и перевести диагональные элементы
в искомые повторы.


\clearpage
