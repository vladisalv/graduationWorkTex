\chapter{Структура программной реализации} \label{chapt2}

Программная реализация выполнена на С++ с использованием технологии
параллельного программирования MPI и технологии CUDA-C для использования
графических процессоров Nvidia. Общий объем кода (программа + GUI) составляет 6 тысяч строк.

Параллельный алгоритм разрабатывался таким способом, чтобы выполнялись следующие условия:
\begin{itemize}
    \item Автономность каждого этапа вычислений
    \item Возможность загрузки/сохранения данных на каждом этапе
    \item Унифицированный доступ к ресурсам системы
\end{itemize}

В результате была разработана следующая структура классов:
\begin{figure}[h]
    \center{\includegraphics[width=0.85\linewidth]{image/class.png}}
    \caption{Диаграмма классов}\label{img:class}
\end{figure}

Структура классов разбивается на следующие части:
\begin{enumerate}
    \item Шаблонные классы, описывающие распределенные структуры данных.
    \item Классы-сущности, специализирующие шаблонные классы.
    \item Классы-вычислители, преобразующие одни классы-сущности в другие классы-сущности.
    \item Управляющие классы, через которые осуществляется взаимодействие с MPI и GPU устройством.
\end{enumerate}
%Более подробное описание всех классов можно посмотреть в Приложении \ref{AppendixA}.

\bigskip

Общая схема работы программы выглядит следующим образом:
\begin{figure}[h]
    \center{\includegraphics[width=0.50\linewidth]{image/program.png}}
    \caption{Блок-схема программы}\label{img:program}
\end{figure}

\bigskip

Данная схема работы позволяет начать и завершить работу на любом этапе,
ограничившись выполнением только нескольких этапов. Такая гибкость программы
может быть очень полезна если пользователь захочет посмотреть
на результат работы программы при разных параметрах. Например, чтобы
посмотреть на поведение программы при разном значении $\varepsilon$, то достаточно
один раз сохранить спектры и в дальнейшем запускать программу сразу
с этапа построения гомологической матрицы.

В целом программа выполнена в виде набора библиотечных функций, поэтому если
пользователю потребуется специфичная версия программы, то относительно просто и
в кротчайшие сроки такая версия может быть реализована.

\bigskip

Для работы с вводом/выводом файлов использовался архитектурно-независимый
интерфейс стандарта MPI-2. Архитектура приложения позволяет использовать
множество форматов ввода/вывода. В частности, для загрузки/сохранения
гомологической матрицы предусмотрено два формата: бинарный файл и bmp изображение.

Для повышения масштабируемости алгоритма использовались только асинхронные
операции передачи данных. Это позволило значительно снизить
коммуникационные издержки, особенно на этапе построения гомологической матрицы
где использовалась схема взаимодействия "all-to-all".

Для реализации этапа "склейки"\ по процессам использовались односторонние коммуникации.
Данная технология MPI позволяет задавать все параметры, относящиеся к пересылке
данных, только на одной стороне, что значительно упростило
его реализацию этапа и повысило его эффективность.

\bigskip

Выделение в отдельные классы взаимодействия с MPI и GPU устройством позволило
при компиляции отключить возможности эти классов и иметь следующие варианты сборки:
\begin{itemize}
    \item последовательная программа
    \item последовательная программа, использующая графические процессоры
    \item параллельная программа без использования графических процессоров
    \item параллельная программа с использованием графических процессоров
\end{itemize}
Данная возможность позволяет существенно расширить список вычислительных платформ
на которых может работать программа.

\bigskip

Тяжелые в вычислительном плане этапы спектрального индексирования
и спектрального сравнения были перенесены на графические процессоры.
Для эффективной работы графических ускорителей использовались механизм общей памяти
и "набивка" данных. С помощью профилировщика было достигнуто такое
разбиение задачи на блоки, что было достигнуто оптимальное соотношение
между occupancy (загруженность устройства) и размером используемой общей памяти.
Все эти меры позволили значительно ускорить этап построения гомологической матрицы.

\bigskip

Для удобства работы с программой был разработан ряд графических интерфейсов.
Стоит отметить, что так как работа программы не предполагает диалога
с пользователем, то данные интерфейсы работают в пакетном режиме,
т.е. задают параметры алгоритма, запускают выполнение основной программы и ждут
результатов. Поэтому все графические интерфейсы базируются
на мощном Command Line Interface, реализованном в основной программе.
CLI следует стандарту Posix, поддерживает разбор коротких и длинных опций.
Таким образом графические интерфейсы правильно формируют строку аргументов
и запускают основную программу.
\clearpage

Реализованы следующие виды интерфейсов:
\begin{itemize}
    \item графический интерфейс на основе кроссплатформенной библиотеки Qt. Данный вариант очень если программа будет работать на локальной машине. (рисунок)
        \begin{figure}[h]
            \center{\includegraphics[width=0.60\linewidth]{image/gui1.png}}
            \caption{Графический интерфейс. Локальная машина}\label{img:program}
        \end{figure}
    \item графический интерфейс на основе кроссплатформенной библиотеки Qt и кроссплатворменной библиотеки libssh2. Данный вариант позволяет запускать программу графического интерфейса на локальном компьютере пользователя и запускать основную программу на удаленном сервере. (рисунок)
        \begin{figure}[h]
            \center{\includegraphics[width=0.60\linewidth]{image/gui2.png}}
            \caption{Графический интерфейс. Удаленная машина}\label{img:program}
        \end{figure}
\end{itemize}

%еще интернет интерфейс и псевдографический

\clearpage
